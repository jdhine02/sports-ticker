<!DOCTYPE html>
<html>
<head>
    <title>Multi-Sport Ticker</title>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        /* Previous styles remain the same */
        body {
            margin: 0;
            padding: 0;
            background: #1a1a1a;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            overflow: hidden;
            height: 60px;
        }

        .ticker-container {
            width: 100%;
            height: 60px;
            overflow: hidden;
            position: relative;
        }

        .ticker {
            display: flex;
            white-space: nowrap;
            padding-right: 100%;
            animation: ticker 40s linear infinite;
        }

        .ticker-item {
            display: inline-flex;
            align-items: center;
            padding: 0 40px;
            color: white;
            font-size: 20px;
            border-right: 1px solid #333;
        }

        .league-badge {
            padding: 2px 6px;
            border-radius: 3px;
            margin-right: 8px;
            font-size: 0.8em;
        }

        /* Sport-specific colors */
        .nhl { background: #041E42; }
        .nfl { background: #013369; }
        .epl { background: #3D195B; }
        .ncaab { background: #FF4716; }
        .ncaaf { background: #7B0000; }
        .wncaab { background: #FF69B4; }

        .score {
            color: #ffd700;
            margin: 0 10px;
            font-weight: bold;
        }

        .live {
            color: #ff4444;
            margin: 0 10px;
            font-weight: bold;
        }

        .upcoming {
            color: #44aaff;
            margin: 0 10px;
        }

        .final {
            color: #44ff44;
            margin: 0 10px;
        }

        .period {
            color: #888;
            margin-left: 10px;
            font-size: 0.9em;
        }

        @keyframes ticker {
            0% { transform: translateX(0); }
            100% { transform: translateX(-100%); }
        }
    </style>
</head>
<body>
    <div class="ticker-container">
        <div class="ticker" id="ticker">
            <div class="ticker-item">Loading sports data...</div>
        </div>
    </div>

    <script>
        const API_KEY = '655edb945e2dca9ca2902bc144a641bb';
        const BASE_URL = 'https://api.the-odds-api.com/v4';
        const CORS_PROXY = 'https://corsproxy.io/?' + encodeURIComponent(BASE_URL);
        const CACHE_KEY = 'sportsTickerData';
        const CACHE_DURATION = 300000; // 5 minutes
        const API_LIMIT = 500; // Monthly API call limit
        const REFRESH_INTERVAL = 300000; // 5 minutes

        // Previous team and sport configurations remain the same
        const TRACKED_TEAMS = {
            sports: {
                'icehockey_nhl': ['Nashville Predators'],
                'americanfootball_nfl': ['Tennessee Titans', 'Chicago Bears'],
                'soccer_epl': ['Arsenal'],
                'basketball_ncaab': ['Louisville Cardinals', 'Michigan State Spartans'],
                'americanfootball_ncaaf': ['Louisville Cardinals', 'Michigan State Spartans'],
                'basketball_wncaab': ['Louisville Cardinals']
            }
        };

        const SPORT_FORMATS = {
            // Previous sport formats remain the same
            'icehockey_nhl': {
                cssClass: 'nhl',
                periodPrefix: 'P',
                scoreFormat: 'standard'
            },
            'americanfootball_nfl': {
                cssClass: 'nfl',
                periodPrefix: 'Q',
                scoreFormat: 'standard'
            },
            'soccer_epl': {
                cssClass: 'epl',
                periodPrefix: '',
                scoreFormat: 'soccer'
            },
            'basketball_ncaab': {
                cssClass: 'ncaab',
                periodPrefix: 'H',
                scoreFormat: 'standard'
            },
            'basketball_wncaab': {
                cssClass: 'wncaab',
                periodPrefix: 'H',
                scoreFormat: 'standard'
            },
            'americanfootball_ncaaf': {
                cssClass: 'ncaaf',
                periodPrefix: 'Q',
                scoreFormat: 'standard'
            }
        };

        // API Usage Tracking
        function trackApiCall() {
            const today = new Date().toISOString().split('T')[0];
            const month = today.substring(0, 7); // YYYY-MM
            let usage = JSON.parse(localStorage.getItem('apiUsage') || '{}');
            
            if (!usage[month]) {
                usage[month] = 0;
            }
            usage[month]++;
            
            localStorage.setItem('apiUsage', JSON.stringify(usage));
            
            // Return false if we're over limit
            return usage[month] <= API_LIMIT;
        }

        // Cache Management
        function getCachedData(key) {
            const cached = localStorage.getItem(key);
            if (!cached) return null;
            
            const data = JSON.parse(cached);
            if (Date.now() - data.timestamp > CACHE_DURATION) {
                localStorage.removeItem(key);
                return null;
            }
            
            return data.value;
        }

        function setCachedData(key, value) {
            const data = {
                timestamp: Date.now(),
                value: value
            };
            localStorage.setItem(key, JSON.stringify(data));
        }

        async function fetchWithProxy(endpoint, forceRefresh = false) {
            const cacheKey = `cache_${endpoint}`;
            if (!forceRefresh) {
                const cached = getCachedData(cacheKey);
                if (cached) return cached;
            }

            if (!trackApiCall()) {
                return getCachedData(cacheKey) || null;
            }

            const url = CORS_PROXY + endpoint;
            try {
                const response = await fetch(url, {
                    headers: { 'Accept': 'application/json' }
                });
                
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                
                const data = await response.json();
                setCachedData(cacheKey, data);
                return data;
            } catch (error) {
                return null;
            }
        }

        // Previous formatting functions remain the same
        function formatGameTime(isoString) {
            const date = new Date(isoString);
            const today = new Date();
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);

            if (date.toDateString() === today.toDateString()) {
                return date.toLocaleString('en-US', {
                    hour: 'numeric',
                    minute: '2-digit',
                    timeZone: 'America/New_York'
                }) + ' ET Today';
            } else if (date.toDateString() === tomorrow.toDateString()) {
                return date.toLocaleString('en-US', {
                    hour: 'numeric',
                    minute: '2-digit',
                    timeZone: 'America/New_York'
                }) + ' ET Tomorrow';
            } else {
                return date.toLocaleString('en-US', {
                    weekday: 'short',
                    month: 'numeric',
                    day: 'numeric',
                    hour: 'numeric',
                    minute: '2-digit',
                    timeZone: 'America/New_York'
                }) + ' ET';
            }
        }

        // Optimized data fetching
        async function getOptimizedData() {
            const cachedData = getCachedData(CACHE_KEY);
            if (cachedData) return cachedData;

            const sports = await fetchWithProxy('/sports?apiKey=' + API_KEY + '&all=true');
            if (!sports) return null;

            let allGames = [];
            const sportTitles = {};

            sports.forEach(sport => {
                sportTitles[sport.key] = sport.title;
            });

            for (const sportKey of Object.keys(TRACKED_TEAMS.sports)) {
                const games = await fetchWithProxy(
                    `/sports/${sportKey}/scores?apiKey=${API_KEY}&daysFrom=7&dateFormat=iso`
                );

                if (games) {
                    const relevantGames = games.filter(game => 
                        TRACKED_TEAMS.sports[sportKey].some(team => 
                            game.home_team.includes(team) || 
                            game.away_team.includes(team)
                        )
                    );

                    relevantGames.forEach(game => {
                        allGames.push({
                            ...game,
                            sportKey,
                            sportTitle: sportTitles[sportKey]
                        });
                    });
                }
            }

            const result = {
                games: allGames,
                timestamp: Date.now()
            };

            setCachedData(CACHE_KEY, result);
            return result;
        }

        // Previous display functions remain the same
        function createTickerItem(game, sportKey, sportTitle) {
            // Previous createTickerItem implementation
        }

        async function updateTicker() {
            const data = await getOptimizedData();
            if (!data || !data.games || data.games.length === 0) {
                document.getElementById('ticker').innerHTML = 
                    '<div class="ticker-item">No live or upcoming games found</div>';
                return;
            }

            const games = data.games.sort((a, b) => 
                new Date(a.commence_time) - new Date(b.commence_time)
            );

            let html = '';
            games.forEach(game => {
                html += createTickerItem(game, game.sportKey, game.sportTitle);
            });
            html += html; // Duplicate for continuous scroll

            document.getElementById('ticker').innerHTML = html;
        }

        // Initial update
        updateTicker();

        // Refresh at specified interval
        setInterval(updateTicker, REFRESH_INTERVAL);
    </script>
</body>
</html>
