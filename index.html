<!DOCTYPE html>
<html>
<head>
    <title>Sports Ticker</title>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #1a1a1a;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            overflow: hidden;
            height: 60px;
        }

        .ticker-container {
            width: 100%;
            height: 60px;
            overflow: hidden;
            position: relative;
        }

        .ticker {
            display: flex;
            white-space: nowrap;
            padding-right: 100%;
            animation: ticker 40s linear infinite;
        }

        .ticker-item {
            display: inline-flex;
            align-items: center;
            padding: 0 40px;
            color: white;
            font-size: 20px;
            border-right: 1px solid #333;
        }

        .league-badge {
            padding: 2px 6px;
            border-radius: 3px;
            margin-right: 8px;
            font-size: 0.8em;
        }

        /* Sport-specific colors */
        .nhl { background: #041E42; }
        .nfl { background: #013369; }
        .epl { background: #3D195B; }
        .ncaab { background: #FF4716; }
        .ncaaf { background: #7B0000; }
        .nba { background: #1D428A; }

        .score {
            color: #ffd700;
            margin: 0 10px;
            font-weight: bold;
        }

        .live {
            color: #ff4444;
            margin: 0 10px;
            font-weight: bold;
        }

        .upcoming {
            color: #44aaff;
            margin: 0 10px;
        }

        .final {
            color: #44ff44;
            margin: 0 10px;
        }

        .time {
            color: #888;
            margin-left: 10px;
            font-size: 0.9em;
        }

        @keyframes ticker {
            0% { transform: translateX(0); }
            100% { transform: translateX(-100%); }
        }
    </style>
</head>
<body>
    <div class="ticker-container">
        <div class="ticker" id="ticker">
            <div class="ticker-item">Loading sports data...</div>
        </div>
    </div>

    <script>
        const API_KEY = '655edb945e2dca9ca2902bc144a641bb';
        const BASE_URL = 'https://api.the-odds-api.com/v4';
        const CORS_PROXY = 'https://corsproxy.io/?' + encodeURIComponent(BASE_URL);
        const UPDATE_INTERVAL = 1800000; // 30 minutes
        const LIVE_UPDATE_INTERVAL = 60000; // 1 minute for live games

        // Sport keys and tracked teams
        const SPORT_KEYS = {
            'americanfootball_ncaaf': { title: 'NCAAF', cssClass: 'ncaaf' },
            'americanfootball_nfl': { title: 'NFL', cssClass: 'nfl' },
            'basketball_ncaab': { title: 'NCAAB', cssClass: 'ncaab' },
            'basketball_nba': { title: 'NBA', cssClass: 'nba' },
            'soccer_epl': { title: 'EPL', cssClass: 'epl' },
            'icehockey_nhl': { title: 'NHL', cssClass: 'nhl' }
        };

        // Store final scores until midnight
        let finalScores = new Map();

        async function fetchWithProxy(endpoint) {
            try {
                const response = await fetch(CORS_PROXY + endpoint, {
                    headers: { 'Accept': 'application/json' }
                });
                
                if (!response.ok) return null;
                return await response.json();
            } catch (error) {
                return null;
            }
        }

        async function getGames(sportKey, daysFrom = 1) {
            const scores = await fetchWithProxy(
                `/sports/${sportKey}/scores?apiKey=${API_KEY}&daysFrom=${daysFrom}&dateFormat=iso`
            );
            return scores || [];
        }

        function isGameToday(game) {
            const gameDate = new Date(game.commence_time);
            const today = new Date();
            return gameDate.toDateString() === today.toDateString();
        }

        function shouldKeepFinalScore(game) {
            const now = new Date();
            const midnight = new Date(now);
            midnight.setHours(23, 59, 59, 999);
            return new Date(game.commence_time) <= midnight;
        }

        function formatGameTime(isoString) {
            const date = new Date(isoString);
            return date.toLocaleString('en-US', {
                weekday: 'short',
                month: 'numeric',
                day: 'numeric',
                hour: 'numeric',
                minute: '2-digit',
                timeZone: 'America/New_York'
            }) + ' ET';
        }

        function createTickerItem(game, sportInfo) {
            const now = new Date();
            const gameTime = new Date(game.commence_time);
            const isLive = !game.completed && gameTime <= now;
            const status = game.completed ? 'FINAL' : isLive ? 'LIVE' : 'NEXT';
            const statusClass = isLive ? 'live' : (game.completed ? 'final' : 'upcoming');

            return `
                <div class="ticker-item">
                    <span class="league-badge ${sportInfo.cssClass}">${sportInfo.title}</span>
                    <span class="${statusClass}">${status}</span>
                    ${game.home_team}
                    ${game.scores || game.completed ?
                        `<span class="score">${game.scores?.home || '0'}</span> -
                         <span class="score">${game.scores?.away || '0'}</span>`
                        : 'vs'
                    }
                    ${game.away_team}
                    ${!isLive && !game.completed ?
                        `<span class="time">${formatGameTime(game.commence_time)}</span>`
                        : ''
                    }
                </div>
            `;
        }

        async function updateTicker() {
            try {
                let allGames = [];
                const now = new Date();
                
                // Clear old final scores at midnight
                if (now.getHours() === 0 && now.getMinutes() === 0) {
                    finalScores.clear();
                }

                // Get games for each sport
                for (const [sportKey, sportInfo] of Object.entries(SPORT_KEYS)) {
                    // First check today's games
                    let games = await getGames(sportKey, 1);
                    let hasGamesToday = games.some(game => isGameToday(game));

                    // If no games today, look ahead 3 days
                    if (!hasGamesToday) {
                        games = await getGames(sportKey, 3);
                    }

                    // Add to display list
                    games.forEach(game => {
                        if (game.completed && shouldKeepFinalScore(game)) {
                            finalScores.set(game.id, game);
                        }
                        allGames.push({...game, sportInfo});
                    });
                }

                // Add stored final scores
                finalScores.forEach(game => {
                    if (!allGames.some(g => g.id === game.id)) {
                        allGames.push(game);
                    }
                });

                // Sort games: live first, then upcoming, then completed
                allGames.sort((a, b) => {
                    const aIsLive = !a.completed && new Date(a.commence_time) <= now;
                    const bIsLive = !b.completed && new Date(b.commence_time) <= now;
                    if (aIsLive !== bIsLive) return bIsLive ? 1 : -1;
                    if (a.completed !== b.completed) return a.completed ? 1 : -1;
                    return new Date(a.commence_time) - new Date(b.commence_time);
                });

                // Update display
                const ticker = document.getElementById('ticker');
                if (allGames.length === 0) {
                    ticker.innerHTML = '<div class="ticker-item">No games scheduled</div>';
                    return;
                }

                let html = '';
                allGames.forEach(game => {
                    html += createTickerItem(game, game.sportInfo);
                });
                html += html; // Duplicate for continuous scroll

                ticker.innerHTML = html;

                // Schedule next update
                const hasLiveGames = allGames.some(game => 
                    !game.completed && new Date(game.commence_time) <= now
                );
                setTimeout(updateTicker, hasLiveGames ? LIVE_UPDATE_INTERVAL : UPDATE_INTERVAL);
            } catch (error) {
                setTimeout(updateTicker, UPDATE_INTERVAL);
            }
        }

        // Start updates
        updateTicker();
    </script>
</body>
</html>
